(()=>{"use strict";class e{constructor(){this.fallbackHandlers={},this.telemetryEnabled=!0}registerFallbackHandler(e,t){this.fallbackHandlers[e]=t}setTelemetryEnabled(e){this.telemetryEnabled=e}handleContentError(t){e.MODEL_ERROR_CODES.has(t.code||"")?(this.fallbackToHeuristicAnalysis(),this.logError("model_failure",t)):e.NETWORK_ERROR_CODES.has(t.code||"")?(this.fallbackToCachedResults(),this.logError("network_failure",t)):this.logError("unknown_content_error",t)}handleCredentialError(t){e.CREDENTIAL_ERROR_CODES.has(t.code||"")?(this.fallbackToSourceHeuristics(),this.logError("credential_failure",t)):e.NETWORK_ERROR_CODES.has(t.code||"")?(this.fallbackToCachedCredentials(),this.logError("network_failure",t)):this.logError("unknown_credential_error",t)}logError(e,t){if(this.telemetryEnabled)try{const i={category:e,code:t.code||"UNKNOWN",message:t.message,stack:t.stack,timestamp:(new Date).toISOString()};console.error("Telemetry:",i)}catch(e){console.error("Failed to log telemetry",e)}}fallbackToHeuristicAnalysis(){this.fallbackHandlers.heuristic_analysis?this.fallbackHandlers.heuristic_analysis():console.warn("No fallback handler registered for heuristic analysis")}fallbackToCachedResults(){this.fallbackHandlers.cached_results?this.fallbackHandlers.cached_results():console.warn("No fallback handler registered for cached results")}fallbackToSourceHeuristics(){this.fallbackHandlers.source_heuristics?this.fallbackHandlers.source_heuristics():console.warn("No fallback handler registered for source heuristics")}fallbackToCachedCredentials(){this.fallbackHandlers.cached_credentials?this.fallbackHandlers.cached_credentials():console.warn("No fallback handler registered for cached credentials")}}e.MODEL_ERROR_CODES=new Set(["MODEL_LOAD_FAILED","INFERENCE_TIMEOUT","MODEL_EXECUTION_ERROR","OUT_OF_MEMORY"]),e.NETWORK_ERROR_CODES=new Set(["NETWORK_ERROR","API_UNAVAILABLE","TIMEOUT","RATE_LIMITED"]),e.CREDENTIAL_ERROR_CODES=new Set(["CREDENTIAL_VERIFICATION_FAILED","INVALID_DID","REVOCATION_CHECK_FAILED","CREDENTIAL_EXPIRED"]);var t,i=function(e,t,i,a){return new(i||(i=Promise))((function(r,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}c((a=a.apply(e,t||[])).next())}))};class a{constructor(e){this.did={resolve:e=>i(this,void 0,void 0,(function*(){const t=e.split(":").pop()||"";let i="";try{i=atob(t.substring(0,16))}catch(e){i="unknown"}return{didDocument:{id:e,type:this.getDIDType(i),issuer:`did:cheqd:${this.network}:z6MkwBkJ4N2Jm1H`,issuanceDate:new Date(Date.now()-864e5*Math.floor(30*Math.random())).toISOString()},metadata:{created:new Date(Date.now()-864e5*Math.floor(30*Math.random())).toISOString(),updated:new Date(Date.now()-864e5*Math.floor(5*Math.random())).toISOString()}}}))},this.credential={checkStatus:e=>i(this,void 0,void 0,(function*(){const t=e.charAt(e.length-1);switch(parseInt(t,36)%5){case 0:return{active:!0,revoked:!1,expired:!1};case 1:return{active:!1,revoked:!1,expired:!0,expirationDate:new Date(Date.now()-2592e6).toISOString()};case 2:return{active:!1,revoked:!0,expired:!1,revocationDate:new Date(Date.now()-864e6).toISOString(),revocationReason:"violation of terms"};default:return{active:Math.random()>.3,revoked:!1,expired:!1}}}))},this.apiKey=e.apiKey,this.network=e.network,this.timeout=e.timeout||1e4,console.log(`Initialized cheqd SDK with network: ${this.network} and API key: ${this.apiKey.substring(0,8)}...`)}isReady(){return i(this,void 0,void 0,(function*(){return!0}))}getDIDType(e){return e.includes("news")||e.includes("media")?"NewsPublisher":e.includes("gov")||e.includes("edu")?"OfficialSource":e.includes("fact")||e.includes("check")?"FactChecker":"ContentCreator"}}class r{constructor(t){this.cache=new Map,this.cacheTTL=36e5,this.cheqdClient=null,this.apiKey=t.apiKey,this.network=t.network,this.errorHandler=t.errorHandler||new e,t.cacheTTL&&(this.cacheTTL=t.cacheTTL),this.errorHandler.registerFallbackHandler("cached_credentials",(()=>{console.log("Falling back to cached credentials")})),this.errorHandler.registerFallbackHandler("source_heuristics",(()=>{console.log("Falling back to source heuristics")})),this.initializeCheqdClient()}initializeCheqdClient(){return i(this,void 0,void 0,(function*(){try{this.cheqdClient=new a({apiKey:this.apiKey,network:this.network,timeout:1e4}),yield this.cheqdClient.isReady(),console.log("cheqd client initialized successfully")}catch(e){this.errorHandler.handleCredentialError(e),console.error("Failed to initialize cheqd client:",e)}}))}verifyCredential(e){return i(this,void 0,void 0,(function*(){const t=this.getFromCache(e);if(t)return t;try{if(!this.cheqdClient&&(yield this.initializeCheqdClient(),!this.cheqdClient))throw new Error("Failed to initialize cheqd client");const t=yield this.cheqdClient.did.resolve(e);if(!t||!t.didDocument)throw new Error(`Could not resolve DID: ${e}`);const i=yield this.cheqdClient.credential.checkStatus(e),a=this.mapCredentialResult(t,i);return this.cache.set(e,{result:a,timestamp:Date.now()}),a}catch(e){return this.errorHandler.handleCredentialError(e),{status:"unknown",details:{error:"Verification failed, using fallback"}}}}))}mapCredentialResult(e,t){var i,a,r;try{const n=(null===(i=e.didDocument)||void 0===i?void 0:i.issuanceDate)?new Date(e.didDocument.issuanceDate):void 0,s=(null===(a=e.didDocument)||void 0===a?void 0:a.issuer)||void 0;let o="unknown";!0===t.active?o="valid":!0===t.revoked?o="revoked":!0===t.expired?o="expired":!1===t.active&&(o="invalid");const c={credentialType:(null===(r=e.didDocument)||void 0===r?void 0:r.type)||"unknown"};return t.expirationDate&&(c.expirationDate=new Date(t.expirationDate)),t.revoked&&t.revocationDate&&(c.revocationDate=new Date(t.revocationDate),c.revocationReason=t.revocationReason||"unknown"),{status:o,issuer:s,issuanceDate:n,revocationStatus:!0===t.revoked,details:c}}catch(e){return console.error("Error mapping credential result:",e),{status:"unknown",details:{error:"Failed to parse credential data"}}}}getFromCache(e){const t=this.cache.get(e);if(t&&Date.now()-t.timestamp<this.cacheTTL)return t.result}clearExpiredCache(){const e=Date.now();for(const[t,i]of this.cache.entries())e-i.timestamp>=this.cacheTTL&&this.cache.delete(t)}}class n{constructor(e){this.defaultWeights={sourceVerification:.35,technicalAnalysis:.25,communityRating:.15,temporalFreshness:.15,crossValidation:.1},this.weights=e||this.defaultWeights}updateWeights(e){this.weights=Object.assign(Object.assign({},this.weights),e)}calculateScore(e,t,i,a,r,n=""){const s=[];s.push(this.calculateSourceVerificationFactor(e)),(t||i)&&s.push(this.calculateTechnicalAnalysisFactor(t,i)),s.push(this.calculateTemporalFreshnessFactor(e.issuanceDate)),a&&s.push(this.calculateCrossValidationFactor(a)),void 0!==r&&s.push(this.calculateCommunityRatingFactor(r));let o=0,c=0;s.forEach((e=>{o+=e.score*e.weight,c+=e.weight}));const l=c>0?Math.min(100,Math.max(0,o/c)):0,d=this.calculateTechnicalAnalysisScore(t,i);return{trustScore:l,sourceVerified:"valid"===e.status,technicalAnalysisScore:d,communityRating:r,credentialIssuanceDate:e.issuanceDate,crossValidation:a,factors:s,contentUrl:n,verificationTimestamp:new Date}}calculateSourceVerificationFactor(e){let t=0,i="";switch(e.status){case"valid":t=100,i="Source has valid credentials";break;case"expired":t=50,i="Source has expired credentials";break;case"revoked":t=10,i="Source credentials have been revoked";break;case"invalid":t=0,i="Source has invalid credentials";break;case"unknown":t=30,i="Source credentials could not be verified"}return{name:"Source Verification",description:"Verification of content source using decentralized credentials",score:t,weight:this.weights.sourceVerification,details:i}}calculateTechnicalAnalysisFactor(e,t){const i=this.calculateTechnicalAnalysisScore(e,t);let a="";return e&&(a+=`Media manipulation probability: ${(100*e.manipulationProbability).toFixed(1)}%. `,e.manipulationType&&"none"!==e.manipulationType&&(a+=`Detected ${e.manipulationType}. `)),t&&(a+=`Text misinformation probability: ${(100*t.misinformationProbability).toFixed(1)}%. `),{name:"Technical Analysis",description:"AI-powered analysis of media and text content",score:i,weight:this.weights.technicalAnalysis,details:a.trim()||void 0}}calculateTechnicalAnalysisScore(e,t){let i=100,a=100;return e&&(i=100-100*e.manipulationProbability),t&&(a=100-100*t.misinformationProbability),e&&t?.6*i+.4*a:e?i:t?a:50}calculateTemporalFreshnessFactor(e){const t=function(e){if(!e)return 0;const t=(Date.now()-e.getTime())/864e5;return Math.exp(-t/30)}(e),i=100*t;let a="";return a=e?`Credential issued ${Math.round((Date.now()-e.getTime())/864e5)} days ago`:"No issuance date available",{name:"Temporal Freshness",description:"Recency of the credential issuance",score:i,weight:this.weights.temporalFreshness,details:a}}calculateCrossValidationFactor(e){const{sourcesChecked:t,sourcesCorroborating:i}=e;let a=0;t>0&&(a=i/t*100);let r="";return r=t>0?`${i} out of ${t} sources corroborate this content`:"No cross-validation sources available",{name:"Cross Validation",description:"Verification against other trusted sources",score:a,weight:this.weights.crossValidation,details:r}}calculateCommunityRatingFactor(e){return{name:"Community Rating",description:"Rating provided by the community",score:e,weight:this.weights.communityRating,details:`Community rating: ${e.toFixed(1)}/100`}}}!function(e){e.ANALYZE_CONTENT="ANALYZE_CONTENT",e.VERIFICATION_RESULT="VERIFICATION_RESULT",e.UPDATE_CONFIG="UPDATE_CONFIG",e.REQUEST_CONFIG="REQUEST_CONFIG",e.CONFIG_RESPONSE="CONFIG_RESPONSE",e.REQUEST_VERIFICATION="request_verification",e.OVERLAY_ACTION="overlay_action",e.INJECT_OVERLAY="inject_overlay",e.REMOVE_OVERLAY="remove_overlay",e.REQUEST_CHEQD_STATUS="request_cheqd_status",e.CHEQD_STATUS_RESULT="cheqd_status_result",e.VERIFY_CREDENTIAL="verify_credential"}(t||(t={}));var s=function(e,t,i,a){return new(i||(i=Promise))((function(r,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}c((a=a.apply(e,t||[])).next())}))};const o=new e,c={cheqdApiKey:"[PROTECTED]",cheqdNetwork:"testnet",enableDeepfakeDetection:!0,enableTextAnalysis:!0,showOverlay:!0,warningThreshold:60,factorWeights:{sourceVerification:.35,technicalAnalysis:.25,communityRating:.15,temporalFreshness:.15,crossValidation:.1}};let l,d,h=Object.assign({},c);(function(){return s(this,void 0,void 0,(function*(){try{const e=yield chrome.storage.sync.get("config");e.config&&(h=Object.assign(Object.assign({},c),e.config),h.cheqdApiKey="[PROTECTED]")}catch(e){console.error("Failed to load configuration:",e)}l=new r({apiKey:"caas_1bf059f0661f90756e9d4132d1f996e19a9b1ace6ac8785eb83fb7f0209feea41ffc12de07ccc7c5efa9fa68f57596e71db34376380b822ec58c05d42c2d785d",network:h.cheqdNetwork,errorHandler:o}),d=new n(h.factorWeights),setInterval((()=>{l.clearExpiredCache()}),36e5)}))})().catch((e=>{console.error("Failed to initialize extension:",e)})),chrome.runtime.onMessage.addListener(((e,i,a)=>(s(void 0,void 0,void 0,(function*(){try{switch(e.type){case t.ANALYZE_CONTENT:const i=yield function(e,t,i,a){return s(this,void 0,void 0,(function*(){const r=yield l.verifyCredential(t),n=function(e){const t=e.length,i=3+t%5,a=Math.min(i,Math.max(0,Math.floor(i*(.5+t%10/20))));return{sourcesChecked:i,sourcesCorroborating:a,corroboratingSources:Array(a).fill(0).map(((e,t)=>`Source ${t+1}`))}}(e),s=function(e){const t=e.length;return Math.min(100,Math.max(0,t%100-50+50))}(e);return d.calculateScore(r,i,a,n,s,e)}))}(e.data.url,e.data.did,e.data.mediaAnalysis,e.data.textAnalysis);a({success:!0,result:i});break;case t.UPDATE_CONFIG:yield function(e){return s(this,void 0,void 0,(function*(){h=Object.assign(Object.assign({},h),e),e.factorWeights&&d.updateWeights(e.factorWeights);try{yield chrome.storage.sync.set({config:h})}catch(e){throw console.error("Failed to save configuration:",e),new Error("Failed to save configuration")}}))}(e.data),a({success:!0});break;case t.REQUEST_CONFIG:a({success:!0,config:h});break;case t.VERIFICATION_RESULT:yield function(e){return s(this,void 0,void 0,(function*(){try{let t=(yield chrome.storage.local.get("historyResults")).historyResults||[];t.some((t=>t.contentUrl===e.contentUrl))||(t=[Object.assign(Object.assign({},e),{verificationTimestamp:e.verificationTimestamp instanceof Date?e.verificationTimestamp.toISOString():e.verificationTimestamp,credentialIssuanceDate:e.credentialIssuanceDate instanceof Date?e.credentialIssuanceDate.toISOString():e.credentialIssuanceDate}),...t.slice(0,19)],yield chrome.storage.local.set({historyResults:t}))}catch(e){console.error("Error saving result to history:",e)}}))}(e.result),a({success:!0});break;default:a({success:!1,error:"Unknown message type"})}}catch(e){console.error("Error handling message:",e),a({success:!1,error:e.message})}})),!0)))})();